<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Kadie AI — Discord Login</title>
  <style>
    html,body{height:100%;margin:0}
    body{background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:900px;margin:40px auto;padding:0 16px}
    .btn{display:inline-block;padding:10px 16px;background:#5865F2;color:#fff;text-decoration:none;border-radius:8px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:16px}
    .card{border:1px solid #222;border-radius:10px;padding:12px;background:#0b0b0b}
    .muted{opacity:.45}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid #222;background:#101010;color:#ddd;text-decoration:none}
    .pill[aria-disabled="true"]{pointer-events:none;opacity:.4}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Kadie AI</h1>
    <div id="auth"></div>
    <div id="guilds"></div>
  </div>

  <script>
    const DISCORD_INSTALL_BASE =
      "https://discord.com/oauth2/authorize?client_id=YOUR_APP_ID&permissions=8&integration_type=0&scope=bot%20applications.commands";

    const PERM_ADMIN = 8n;
    const PERM_MANAGE_GUILD = 32n;

    async function jget(p){ const r=await fetch(p,{credentials:'include'}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    async function init(){
      // auth state
      let me=null;
      try { me = await jget("/api/me"); } catch {}
      const authEl = document.getElementById("auth");
      authEl.innerHTML = me
        ? `<p>Signed in as <strong>${me.username}#${me.discriminator ?? me.global_name ?? ""}</strong> · <a class="pill" href="/api/logout">Log out</a></p>`
        : `<a class="btn" href="/api/login">Sign in with Discord</a>`;

      if(!me) return;

      // guilds
      const guildsWrap = document.getElementById("guilds");
      guildsWrap.innerHTML = "<h2>Your Servers</h2><div class='grid' id='grid'></div>";
      const grid = document.getElementById("grid");
      let guilds = await jget("/api/guilds");

      guilds.forEach(g=>{
        const perms = BigInt(g.permissions ?? "0");
        const manageable = g.owner || (perms & PERM_ADMIN) !== 0n || (perms & PERM_MANAGE_GUILD) !== 0n;

        const card = document.createElement("div");
        card.className = "card" + (manageable ? "" : " muted");

        const icon = g.icon
          ? `https://cdn.discordapp.com/icons/${g.id}/${g.icon}.png?size=64`
          : `https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f5bc.svg`;

        card.innerHTML = `
          <div style="display:flex;gap:10px;align-items:center">
            <img src="${icon}" alt="" width="32" height="32" style="border-radius:6px;background:#111">
            <div>
              <div style="font-weight:600">${g.name}</div>
              <div style="font-size:12px;color:#bbb">${g.id}</div>
            </div>
          </div>
          <div class="row">
            <a class="pill" href="${DISCORD_INSTALL_BASE}&guild_id=${g.id}&disable_guild_select=true">Add/Invite Bot</a>
            <a class="pill" ${manageable ? "" : 'aria-disabled="true"'}
               href="${manageable ? `/kadie-ai/bot-config.html?guild_id=${g.id}` : '#'}">Manage Bot</a>
          </div>
        `;
        grid.appendChild(card);
      });
    }
    init();
  </script>
</body>
</html>
