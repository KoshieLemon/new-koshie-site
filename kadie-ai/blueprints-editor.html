<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Kadie AI â€¢ Blueprints Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <link rel="stylesheet" href="/assets/main.css" />
  <style>
    :root{ --pad:12px; }
    html,body{height:100%;margin:0;background:#0b0b0c;}

    #editor{ position:fixed; inset:0; background:#0b0b0c; }
    .grid{position:absolute;inset:0;background:
      linear-gradient(#1a1a1a 1px, transparent 1px),
      linear-gradient(90deg,#1a1a1a 1px, transparent 1px);
      background-size:24px 24px,24px 24px}
    .nodes{position:absolute;inset:0}
    svg.wires{position:absolute;inset:0;pointer-events:none}
    path.wire{fill:none;stroke:#7dd3fc;stroke-width:3px;filter:drop-shadow(0 0 4px #7dd3fcaa)}
    path.wire.data{stroke:#a7f3d0;filter:drop-shadow(0 0 4px #a7f3d0aa)}
    .node{position:absolute;min-width:180px;background:#17181b;color:#eaeaea;border:1px solid #3a3d47;border-radius:10px;box-shadow:0 6px 18px #0006;user-select:none}
    .context{position:absolute;background:#121317;border:1px solid #2e3342;border-radius:8px;box-shadow:0 10px 24px #000a;padding:6px;min-width:260px;z-index:60;max-height:60vh;overflow:auto}
    .rubber{position:absolute;border:1px dashed #5ac8fa;background:#5ac8fa22;display:none;z-index:55}
    .disabled-overlay{position:absolute;inset:0;background:#000000aa;display:flex;align-items:center;justify-content:center;color:#aaa;font-weight:600;font-size:14px;z-index:40}

    .dock{
      position:fixed; top:var(--pad); bottom:var(--pad); z-index:85;
      background:#0b0c0ff5;border:1px solid #0004;border-radius:12px;padding:10px;overflow:auto;
      transition:width .08s ease;
    }
    #bpdock{ left:var(--pad); width:280px; }
    #varsDock{ right:var(--pad); width:320px; }

    .resizer{position:absolute;top:0;bottom:0;width:10px;opacity:0;transition:opacity .12s}
    .dock:hover .resizer{opacity:.6}
    #bpdock .resizer{ right:-5px; cursor:ew-resize; }
    #varsDock .resizer{ left:-5px; cursor:ew-resize; }
    .dock.resizing{cursor:ew-resize;user-select:none}

    .bp-list{display:flex;flex-direction:column;gap:10px}
    .chip{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border:1px solid #1e2230;border-radius:12px;
      padding:10px 12px;
      background:#11131a;color:#e5e7eb;
      font-size:13px;line-height:1.1;
      width:100%;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .chip .name{max-width:calc(100% - 36px);overflow:hidden;text-overflow:ellipsis}
    .chip.active{border-color:#60a5fa; box-shadow:0 0 0 2px #60a5fa22}
    .chip .x{display:none;border:0;background:#0000;color:#fca5a5;font-weight:700;cursor:pointer}
    .chip:hover .x{display:inline}
    .chip.add{border-style:dashed;color:#9ca3af;justify-content:center}

    .chip .dot{width:10px;height:10px;border-radius:50%;border:1px solid #0006;flex:0 0 auto}
    .chip .type{opacity:.85;font-size:11px;border:1px solid #2b2f3a;border-radius:999px;padding:2px 6px;background:#0f1117}
    .chip input.rename{background:#0f1117;border:1px solid #292e3e;color:#e5e7eb;border-radius:6px;padding:2px 6px;font-size:12px;min-width:80px;max-width:200px}

    .row{display:flex;gap:8px;align-items:center}
    .search{position:sticky;top:0;background:#0b0c0f;padding-bottom:8px;z-index:1}
    .search input[type="search"]{flex:1;box-sizing:border-box;border:1px solid #2b2f3a;background:#11131a;color:#eaeaea;padding:6px 8px;border-radius:8px;outline:none}
    .btn{border:1px solid #0003;background:#111;color:#eee;padding:6px 8px;border-radius:8px;cursor:pointer}
    .copy-hint{font-size:11px;color:#9aa3af;margin:6px 0 0 0}

    #dirty{
      position:fixed; top:10px; left:50%; transform:translate(-50%,-140%);
      background:#0b1020; color:#e5e7eb; border:1px solid #1f2937; border-radius:10px;
      box-shadow:0 12px 36px rgba(0,0,0,.55);
      padding:8px; display:flex; align-items:center; gap:8px;
      font:600 12px/1.1 system-ui,Segoe UI,Roboto,Arial,sans-serif;
      z-index:1000; opacity:0; transition:transform .22s cubic-bezier(.2,.8,.2,1), opacity .22s ease;
      pointer-events:auto;
    }
    #dirty .sp{flex:1;min-width:0}
    #dirty .msg{opacity:.9}
    #dirty .actions{display:flex;gap:6px}
    #dirty .actions .btn{ border:1px solid #1f2937; background:#131a2a; color:#e5e7eb; padding:6px 10px; border-radius:8px; }
    #dirty .actions .btn.primary{ background:#1d4ed8; border-color:#1e40af; }
    #dirty.show{ transform:translate(-50%,0); opacity:1; }
  </style>
</head>
<body>
  <div style="display:none">
    <select id="bpSelect"></select>
    <button id="bpCreate" type="button">Create</button>
    <button id="bpRename" type="button">Rename</button>
    <button id="bpDelete" type="button">Delete</button>
    <button id="undoBtn" type="button">Undo</button>
    <button id="redoBtn" type="button">Redo</button>
  </div>

  <div id="dirty" class="show" aria-live="polite" role="region">
    <span class="msg">Unsaved changes</span>
    <span class="sp"></span>
    <div class="actions">
      <button id="revertBtn" class="btn" type="button" title="Revert changes">Revert</button>
      <button id="saveBtn" class="btn primary" type="button" title="Save blueprint">Save</button>
    </div>
  </div>

  <div class="editor-wrap" id="editor">
    <div class="grid"></div>
    <svg class="wires" id="wires" viewBox="0 0 1000 1000" preserveAspectRatio="none"></svg>
    <div class="nodes" id="nodes"></div>
    <div class="disabled-overlay" id="disabledOverlay">Select or create a blueprint to edit</div>
    <div class="context" id="ctx" style="display:none"></div>
    <div class="rubber" id="rubber"></div>
  </div>

  <aside class="dock" id="bpdock" aria-label="Blueprints">
    <div class="resizer" aria-hidden="true"></div>
    <div class="bp-list" id="bpList"></div>
  </aside>

  <aside class="dock" id="varsDock" aria-label="Variables and Guild Objects">
    <div class="resizer" aria-hidden="true"></div>
    <div class="search row">
      <input id="dockSearch" type="search" placeholder="Search variables, channels, or roles" autocomplete="off">
      <button class="btn" id="varsAdd">+</button>
    </div>
    <div id="dockList" class="bp-list" aria-live="polite"></div>
  </aside>

  <script>
    (function(){
      const rb = document.getElementById('revertBtn');
      if (rb){
        rb.addEventListener('click', ()=>{
          const sel = document.getElementById('bpSelect');
          if (!sel || !sel.value) return;
          sel.dispatchEvent(new Event('change', { bubbles:true }));
        });
      }
    })();
  </script>

  <!-- Inlined former /kadie-ai/blueprints-editor.js -->
  <script type="module">
    import './blueprints-editor-src/core/index.js';
    import './blueprints-editor-src/core/events-ui.js';
    import './blueprints-editor-src/variables/variables-dock.js';
    import './blueprints-editor-src/blueprints/blueprints-dock.js';
  </script>

  <script type="module" src="/kadie-ai/blueprints-editor-src/menus/pin-actions.js?v=2"></script>
</body>
</html>
